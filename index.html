<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shipment</title>

  <link rel="stylesheet" as="style" crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --surface:#ffffff;
      --surface2:#fbfbff;
      --ink:#18162a;
      --muted:#6b6780;

      --line:#ece9ff;
      --line2:#e2ddff;

      --p:#6f5cff;         /* primary */
      --p2:#9a8cff;        /* soft primary */
      --pbg:#f3f1ff;       /* primary bg */
      --shadow: 0 16px 40px rgba(20, 10, 60, .08);
      --shadow2: 0 10px 26px rgba(20, 10, 60, .06);

      --ok:#3a2fe6;
      --okbg: rgba(111, 92, 255, .10);
      --okbd: rgba(111, 92, 255, .28);

      --low:#b34d00;
      --lowbg: rgba(255, 153, 0, .12);
      --lowbd: rgba(255, 153, 0, .35);

      --out:#c1002a;
      --outbg: rgba(255, 60, 90, .12);
      --outbd: rgba(255, 60, 90, .35);

      --na:#4a4a60;
      --nabg: rgba(120,120,150,.10);
      --nabd: rgba(120,120,150,.25);

      --radius: 18px;
      --radius2: 14px;
    }

    *{box-sizing:border-box;font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(900px 520px at 15% 5%, rgba(111,92,255,.10), transparent 60%),
        radial-gradient(900px 520px at 90% 18%, rgba(154,140,255,.10), transparent 58%),
        var(--bg);
      color:var(--ink);
    }

    .app{
      max-width: 1520px;
      margin: 0 auto;
      padding: 18px 16px 90px;
    }

    /* ===== Header / Dashboard ===== */
    .header{
      display:flex;
      gap:14px;
      align-items:stretch;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .brand{
      flex: 1 1 260px;
      background: linear-gradient(180deg, var(--surface), var(--surface2));
      border: 1px solid var(--line2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height: 92px;
    }
    .brand-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand-title{
      font-weight: 1000;
      font-size: 18px;
      letter-spacing: -0.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--p);
      box-shadow: 0 0 0 4px rgba(111,92,255,.12);
    }
    .links{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    a.pill{
      text-decoration:none;
      font-weight: 900;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      background: var(--pbg);
      border: 1px solid rgba(111,92,255,.24);
      color: rgba(35, 25, 90, .92);
      box-shadow: 0 1px 0 rgba(255,255,255,.7) inset;
      transition: .12s ease;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    a.pill:hover{
      transform: translateY(-1px);
      border-color: rgba(111,92,255,.42);
      box-shadow: 0 0 0 4px rgba(111,92,255,.10), 0 1px 0 rgba(255,255,255,.7) inset;
    }
    .statusline{
      margin-top: 10px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.2;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow2);
      font-weight: 900;
      color: rgba(30, 22, 70, .92);
      white-space:nowrap;
    }
    .chip .small{
      font-weight: 800;
      color: rgba(107,103,128,.95);
    }
    .chip.ok{ border-color: var(--okbd); background: var(--okbg); color: rgba(40,25,130,.95); }
    .chip.low{ border-color: var(--lowbd); background: var(--lowbg); color: rgba(130,60,0,.95); }
    .chip.out{ border-color: var(--outbd); background: var(--outbg); color: rgba(140,0,35,.98); }
    .chip.na{ border-color: var(--nabd); background: var(--nabg); color: rgba(70,70,95,.95); }

    .controls{
      flex: 1 1 520px;
      background: linear-gradient(180deg, var(--surface), var(--surface2));
      border: 1px solid var(--line2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      min-height: 92px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .field{
      flex: 1 1 280px;
      min-width: 260px;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow2);
      transition: .12s ease;
    }
    .field:focus-within{
      border-color: rgba(111,92,255,.55);
      box-shadow: 0 0 0 4px rgba(111,92,255,.10), var(--shadow2);
    }
    .label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(107,103,128,.95);
      white-space: nowrap;
    }
    .field input{
      width:100%;
      border:0; outline:0;
      background: transparent;
      font-size: 13px;
      color: rgba(24, 22, 42, .95);
    }

    .btn{
      border:0;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 1000;
      font-size: 13px;
      background: rgba(255,255,255,.9);
      border: 1px solid var(--line2);
      box-shadow: var(--shadow2);
      color: rgba(30, 22, 70, .92);
      transition: .12s ease;
      white-space:nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(111,92,255,.45);
      box-shadow: 0 0 0 4px rgba(111,92,255,.10), var(--shadow2);
    }
    .btn:disabled{
      cursor:not-allowed;
      opacity:.55;
      transform:none;
      box-shadow:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(111,92,255,.95), rgba(111,92,255,.86));
      border-color: rgba(111,92,255,.55);
      color: #fff;
    }
    .btn.primary:hover{
      box-shadow: 0 0 0 4px rgba(111,92,255,.16), var(--shadow2);
      border-color: rgba(111,92,255,.70);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255, 60, 90, .95), rgba(225, 25, 60, .88));
      border-color: rgba(255, 60, 90, .55);
      color:#fff;
    }

    .seg{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow2);
      user-select:none;
    }
    .toggle input{ accent-color: var(--p); }
    .toggle span{
      font-size: 12px;
      font-weight: 900;
      color: rgba(60,55,90,.92);
      white-space:nowrap;
    }

    /* ===== Layout: Table + Preview ===== */
    .layout{
      display:grid;
      grid-template-columns: 1fr 380px;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 1120px){
      .layout{ grid-template-columns: 1fr; }
      .preview{ position: static; }
    }

    .panel{
      background: linear-gradient(180deg, var(--surface), var(--surface2));
      border: 1px solid var(--line2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-head{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panel-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 1000;
      font-size: 13px;
      color: rgba(35, 25, 90, .92);
    }
    .panel-title .sub{
      font-weight: 900;
      color: rgba(107,103,128,.95);
      font-size: 12px;
    }

    /* ===== Table ===== */
    .table-wrap{
      width:100%;
      overflow:auto;
      max-height: 72vh;
      scrollbar-gutter: stable;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size: 12px;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(255,255,255,.92);
      border-bottom: 1px solid var(--line);
      padding: 10px 10px;
      text-align:left;
      font-weight: 1000;
      color: rgba(35, 25, 90, .92);
      white-space:nowrap;
      backdrop-filter: blur(8px);
    }
    tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(236,233,255,.9);
      white-space: nowrap;
      vertical-align: top;
      color: rgba(24, 22, 42, .95);
    }
    tbody tr:hover{
      background: rgba(111,92,255,.06);
    }
    tbody tr:nth-child(even){
      background: rgba(251,251,255,.65);
    }

    /* stock state row tint */
    tbody tr.low{ background: rgba(255, 153, 0, .08) !important; }
    tbody tr.out{ background: rgba(255, 60, 90, .08) !important; }
    tbody tr.na { background: rgba(120,120,150,.07) !important; }

    /* selected row */
    tbody tr.is-selected{
      outline: 2px solid rgba(111,92,255,.35);
      outline-offset: -2px;
      background: rgba(111,92,255,.10) !important;
    }

    /* sticky first cols (# + checkbox) */
    .stickyA, .stickyB{
      position: sticky;
      left: 0;
      z-index: 3;
      background: inherit;
    }
    .stickyB{
      left: 32px;
      z-index: 3;
    }
    thead .stickyA, thead .stickyB{
      z-index: 8;
      background: rgba(255,255,255,.92);
    }

    .cell{
      max-width: 420px;
      overflow:hidden;
      text-overflow:ellipsis;
      cursor: pointer;
    }

    .chkcell{ text-align:center; }
    .rowChk{
      width: 16px; height: 16px;
      accent-color: var(--p);
      cursor:pointer;
    }

    .nodata{
      padding: 18px 14px;
      color: rgba(107,103,128,.85);
      font-size: 12px;
      text-align:center;
    }

    /* ===== Preview panel ===== */
    .preview{
      position: sticky;
      top: 14px;
    }
    .preview-body{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .preview-empty{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(111,92,255,.28);
      background: rgba(111,92,255,.06);
      color: rgba(80,75,110,.92);
      font-size: 12px;
      line-height: 1.35;
    }
    .kv{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.86);
      overflow:hidden;
    }
    .kv .k{
      padding: 8px 10px;
      font-size: 11px;
      font-weight: 1000;
      color: rgba(107,103,128,.92);
      border-bottom: 1px solid var(--line);
      background: rgba(251,251,255,.8);
    }
    .kv .v{
      padding: 10px 10px;
      font-size: 12px;
      font-weight: 800;
      color: rgba(24,22,42,.95);
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.35;
    }
    .preview-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 2px;
    }

    /* ===== Inline badges ===== */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-weight: 1000;
      font-size: 12px;
      border: 1px solid;
      white-space:nowrap;
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,.86);
    }
    .badge.ok { background: var(--okbg); border-color: var(--okbd); color: rgba(40,25,130,.95); }
    .badge.low{ background: var(--lowbg); border-color: var(--lowbd); color: rgba(130,60,0,.95); }
    .badge.out{ background: var(--outbg); border-color: var(--outbd); color: rgba(140,0,35,.98); }
    .badge.na { background: var(--nabg); border-color: var(--nabd); color: rgba(70,70,95,.95); }

    /* ===== Bottom Action Bar ===== */
    .actionbar{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      width: min(1100px, calc(100vw - 28px));
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line2);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(20, 10, 60, .14);
      backdrop-filter: blur(12px);
      padding: 10px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      z-index: 2000;
    }
    .actionbar.show{ display:flex; }
    .action-left{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      min-width: 200px;
    }
    .action-right{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .action-title{
      font-weight: 1000;
      font-size: 13px;
      color: rgba(35, 25, 90, .92);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .action-sub{
      font-size: 12px;
      font-weight: 900;
      color: rgba(107,103,128,.95);
    }
    .warn{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid;
      font-size: 12px;
      font-weight: 1000;
      white-space:nowrap;
    }
    .warn.ok{ background: var(--okbg); border-color: var(--okbd); color: rgba(40,25,130,.95); }
    .warn.low{ background: var(--lowbg); border-color: var(--lowbd); color: rgba(130,60,0,.95); }
    .warn.out{ background: var(--outbg); border-color: var(--outbd); color: rgba(140,0,35,.98); }
    .warn.na { background: var(--nabg); border-color: var(--nabd); color: rgba(70,70,95,.95); }

    /* ===== Toast ===== */
    #toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(111,92,255,.28);
      box-shadow: var(--shadow);
      opacity:0;
      transform: translateY(10px);
      transition: .18s ease;
      pointer-events: none;
      font-weight: 1000;
      color: rgba(35, 25, 90, .92);
    }
    #toast.show{ opacity:1; transform:translateY(0); }

    /* ===== Modal for "full view" ===== */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(15, 10, 40, .45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 3000;
      padding: 18px;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width: min(920px, 96vw);
      max-height: min(86vh, 780px);
      overflow:auto;
      background: #fff;
      border-radius: 18px;
      border: 1px solid var(--line2);
      box-shadow: 0 28px 90px rgba(10, 5, 40, .25);
    }
    .modal-head{
      position: sticky;
      top: 0;
      background: rgba(255,255,255,.92);
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(10px);
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modal-title{
      font-weight: 1000;
      font-size: 13px;
      color: rgba(35, 25, 90, .92);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .modal-body{
      padding: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.45;
      font-size: 13px;
      color: rgba(24, 22, 42, .95);
    }

    /* ===== Small helpers ===== */
    .spinner{
      width:14px; height:14px;
      border-radius: 50%;
      border: 2px solid rgba(111,92,255,.20);
      border-top-color: rgba(111,92,255,.90);
      display:inline-block;
      animation: spin .8s linear infinite;
      vertical-align:-2px;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    .sr{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
</head>

<body>
  <div class="app">

    <!-- ===== Header / Dashboard ===== -->
    <div class="header">
      <div class="brand">
        <div class="brand-top">
          <div class="brand-title"><span class="dot"></span> Shipment <span class="sr">tool</span></div>
          <div class="links">
            <a class="pill" id="orderLink" href="#" target="_blank" rel="noopener noreferrer">발주서</a>
            <a class="pill" id="stockLink" href="#" target="_blank" rel="noopener noreferrer">재고</a>
            <a class="pill" id="existLink" href="#" target="_blank" rel="noopener noreferrer">출고</a>
          </div>
        </div>
        <div class="statusline">
          <span class="chip" id="dashStatus"><span class="small">상태</span> 로딩 중…</span>
          <span class="chip" id="dashCounts"><span class="small">데이터</span> -</span>
          <span class="chip" id="dashTarget"><span class="small">복사대상</span> -</span>
          <span class="chip na" id="dashGate"><span class="small">복사</span> 대기</span>
        </div>
      </div>

      <div class="controls">
        <div class="row">
          <div class="field">
            <span class="label">주문번호</span>
            <input id="orderInput" type="text" placeholder="쇼핑몰 주문번호 입력 후 Enter" />
          </div>
          <button class="btn primary" id="btnSearch" type="button">조회</button>
          <button class="btn" id="btnCopy" type="button" disabled>복사</button>
          <button class="btn" id="btnClear" type="button">초기화</button>
        </div>

        <div class="seg">
          <label class="toggle" title="기본(중요) 컬럼만 보기 / 상세 컬럼도 보기">
            <input type="checkbox" id="toggleDetails" />
            <span>상세 컬럼 보기</span>
          </label>

          <label class="toggle" title="체크가 없으면 전체, 체크가 있으면 선택만 복사합니다 (A안: 선택 대상에 재고 부족 포함 시 복사 차단)">
            <input type="checkbox" id="toggleSelectMode" checked />
            <span>체크 우선 복사</span>
          </label>

          <span class="chip" id="dashHint"><span class="small">팁</span> 행 클릭 → 우측 미리보기 · 셀 클릭 → 값 복사</span>
        </div>
      </div>
    </div>

    <!-- ===== Main Layout ===== -->
    <div class="layout">

      <!-- ===== Left: Table panel ===== -->
      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">검색 결과 <span class="sub" id="resultSub">-</span></div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button class="btn" id="btnSelectAll" type="button" style="display:none;">전체 선택</button>
            <button class="btn" id="btnSelectNone" type="button" style="display:none;">선택 해제</button>
          </div>
        </div>
        <div class="table-wrap" id="tableWrap">
          <div class="nodata">검색 결과가 없습니다.</div>
        </div>
      </div>

      <!-- ===== Right: Preview ===== -->
      <div class="panel preview">
        <div class="panel-head">
          <div class="panel-title">미리보기 <span class="sub" id="previewSub">선택한 행 없음</span></div>
          <button class="btn" id="btnPreviewCopyAll" type="button" disabled>행 전체 복사</button>
        </div>
        <div class="preview-body" id="previewBody">
          <div class="preview-empty">
            왼쪽 표에서 <b>행</b>을 클릭하면 상세가 여기에 정리됩니다.<br/>
            셀은 클릭하면 해당 값이 바로 복사됩니다.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bottom Action Bar (선택 시) -->
  <div class="actionbar" id="actionBar">
    <div class="action-left">
      <div class="action-title">
        <span class="dot" style="width:9px;height:9px;"></span>
        <span id="abTitle">선택 0건</span>
        <span class="action-sub" id="abSub">체크된 항목만 복사</span>
      </div>
      <span class="warn na" id="abWarn">대기</span>
    </div>
    <div class="action-right">
      <button class="btn" id="abCopy" type="button" disabled>선택만 복사</button>
      <button class="btn" id="abClear" type="button">선택 해제</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast">복사됨</div>

  <!-- Modal for full view -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div class="modal-title"><span class="dot" style="width:9px;height:9px;"></span> 전체 보기</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" id="btnModalCopy" type="button">복사</button>
          <button class="btn" id="btnModalClose" type="button">닫기</button>
        </div>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

<script>
/* =========================================================
   Data & Constants
========================================================= */
const LOW_STOCK_THRESHOLD = 10;

// 발주서
const ORDER_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/edit?gid=518656308#gid=518656308";
const ORDER_CSV_BASE =
  "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/export?format=csv&gid=518656308";

// 재고 시트
const STOCK_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/edit?gid=366983013#gid=366983013";
const STOCK_CSV_BASE =
  "https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/export?format=csv&gid=366983013";

// 목적/전산 처리 방법(출고) 시트 (필요 시 유지)
const EXIST_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc/edit?gid=0#gid=0";
const EXIST_CSV_BASE =
  "https://docs.google.com/spreadsheets/d/1LPy69E2yPTaSwxFAYrX6qV0BZx1tW0YdonLRNqeo5Vc/export?format=csv&gid=0";

// Links
document.getElementById("orderLink").href = ORDER_SHEET_URL_VIEW;
document.getElementById("stockLink").href = STOCK_SHEET_URL_VIEW;
document.getElementById("existLink").href = EXIST_SHEET_URL_VIEW;

// CSV 0-based: A=0, B=1, C=2, D=3
const EXTRA_COLS = [
  { key: "__B", label: "사방넷주문번호", idx: 1 },
  { key: "__C", label: "쇼핑몰 주문번호(필수)", idx: 2 },
  { key: "__D", label: "쇼핑몰", idx: 3 },
];

// Output headers (copy)
const OUTPUT_HEADERS = [
  "요청일",
  "수령인","배송수단","운송장 번호","받는분연락처","받는분 기타연락처","주소","배송메세지",
  "상품명","수량","결제금액","큐텐(한글상품명)","바코드","큐텐바코드",
  "상품코드","쇼핑몰(참고용)","상품컬러코드","상품명(수집)","옵션(수집)","주문자명",
  "비고"
];

// 숨김열(화면)
const HIDE_IN_VIEW = new Set([
  "배송수단","운송장 번호","받는분연락처","받는분 기타연락처","주소","배송메세지",
  "큐텐(한글상품명)","큐텐바코드","쇼핑몰(참고용)","상품명(수집)""비고"
]);

const TABLE_COLS_COPY = [
  { key: "요청일", label: "요청일" },
  ...EXTRA_COLS.map(c => ({ key:c.key, label:c.label })),
  { key: "수령인", label: "수령인" },
  ...OUTPUT_HEADERS
    .filter(h => !["요청일","수령인"].includes(h))
    .map(h => ({ key:h, label:h }))
];

const TABLE_COLS_VIEW_ALL = TABLE_COLS_COPY.filter(c => !HIDE_IN_VIEW.has(c.label));

// 기본(중요) 컬럼만
const DEFAULT_VIEW_LABELS = new Set([
  "요청일","사방넷주문번호","쇼핑몰 주문번호(필수)","쇼핑몰",
  "상품명","수량","상품컬러코드","옵션(수집)","바코드","상품코드","비고"
]);

function getCurrentViewCols_(){
  const showDetails = $("toggleDetails")?.checked;
  if(showDetails) return TABLE_COLS_VIEW_ALL;
  return TABLE_COLS_VIEW_ALL.filter(c => DEFAULT_VIEW_LABELS.has(c.label));
}

// 대충 폭(ellipsis용)
const COL_WIDTH = {
  "요청일": 86,
  "사방넷주문번호": 120,
  "쇼핑몰 주문번호(필수)": 160,
  "쇼핑몰": 120,
  "상품명": 320,
  "수량": 70,
  "바코드": 140,
  "상품코드": 110,
  "상품컬러코드": 140,
  "옵션(수집)": 140,
  "비고": 180,
  "_default": 120
};

/* =========================================================
   Utilities
========================================================= */
const $ = (id)=>document.getElementById(id);

function showToast(msg="복사됨"){
  const el = $("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 850);
}

function normalizeKey(v){
  return String(v ?? "")
    .replace(/[\u200B-\u200D\uFEFF]/g, "")
    .trim();
}
function normalizeOrderNo(v){ return normalizeKey(v); }

function normColorCode(v){
  return normalizeKey(v).replace(/\s+/g,"").replace(/-/g,"").toUpperCase();
}
function normProductCode_(v){
  return normalizeKey(v).replace(/\s+/g,"").toUpperCase();
}
function toNumber(v){
  const n = String(v ?? "").replace(/[^0-9.-]/g,"");
  return Number(n) || 0;
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function safeGet(row, idx){
  if(!row || idx == null || idx < 0) return "";
  return (row[idx] ?? "");
}

function withCacheBust(url){
  const sep = url.includes("?") ? "&" : "?";
  return `${url}${sep}_=${Date.now()}`;
}
function looksLikeBadCsv(text){
  const t = String(text || "").trim();
  if(!t) return true;
  const head = t.slice(0, 200).toLowerCase();
  if(head.includes("<!doctype") || head.includes("<html") || head.includes("servicelogin")) return true;
  if(t.length < 30) return true;
  return false;
}
async function fetchText(url, timeoutMs = 9000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, { signal: controller.signal, cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  } finally {
    clearTimeout(t);
  }
}
async function fetchCsvSmart(baseUrl, timeoutMs=9000){
  const t1 = await fetchText(baseUrl, timeoutMs).catch(()=> "");
  if(!looksLikeBadCsv(t1)) return t1;

  const t2 = await fetchText(withCacheBust(baseUrl), timeoutMs).catch(()=> "");
  if(!looksLikeBadCsv(t2)) return t2;

  return t2 || t1;
}

function setDashStatus_(text, loading=false){
  const el = $("dashStatus");
  if(!el) return;
  el.innerHTML = loading
    ? `<span class="small">상태</span> <span class="spinner"></span> ${escapeHtml(text)}`
    : `<span class="small">상태</span> ${escapeHtml(text)}`;
}
function setDashCounts_(text){
  const el = $("dashCounts");
  if(!el) return;
  el.innerHTML = `<span class="small">데이터</span> ${escapeHtml(text)}`;
}
function setDashTarget_(text){
  const el = $("dashTarget");
  if(!el) return;
  el.innerHTML = `<span class="small">복사대상</span> ${escapeHtml(text)}`;
}
function setDashGate_(type, text){
  const el = $("dashGate");
  if(!el) return;
  el.className = `chip ${type || "na"}`;
  el.innerHTML = `<span class="small">복사</span> ${escapeHtml(text)}`;
}

function badgeTextByType_(type, counts){
  if(type === "out") return `OUT ${counts.out}건`;
  if(type === "low") return `LOW ${counts.low}건`;
  if(type === "na")  return `N/A ${counts.na}건`;
  return `OK ${counts.ok}건`;
}

/* =========================================================
   CSV parsing
========================================================= */
function parseCsvWithPapa(csvText, onDone){
  Papa.parse(csvText, {
    skipEmptyLines: true,
    worker: true,
    complete: (results)=> onDone(results)
  });
}

/* =========================================================
   Stock Maps
========================================================= */
let stockMap = new Map();
let stockInfoMap = new Map();
let stockLoaded = false;

function buildStockMapsFromParsed_(results){
  const rows = (results.data || []).slice(1).filter(r => r && r.length > 0);
  stockMap = new Map();
  stockInfoMap = new Map();

  for(const r of rows){
    const code = normColorCode(r[0]);
    if(!code) continue;

    const name = normalizeKey(r[5]);      // F
    const colorName = normalizeKey(r[8]); // I
    const qty = toNumber(r[10]);          // K

    stockMap.set(code, qty);
    stockInfoMap.set(code, { qty, name, colorName });
  }
}

function stockStatusByColorCode(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return { type:"na", label:"재고 미등록", qty:null };
  if(!stockMap.has(code)) return { type:"na", label:"재고 미등록", qty:null };

  const qty = stockMap.get(code);
  if(qty <= 0) return { type:"out", label:`재고 0`, qty };
  if(qty < LOW_STOCK_THRESHOLD) return { type:"low", label:`재고 ${qty} (${LOW_STOCK_THRESHOLD} 미만)`, qty };
  return { type:"ok", label:`재고 ${qty}`, qty };
}
function stockQtyLabel_(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return "미등록";
  if(!stockMap.has(code)) return "미등록";
  return String(stockMap.get(code));
}
function stripStockTag_(s){
  return String(s ?? "").replace(/\s*\[재고:.*?\]\s*/g, " ").trim();
}
function attachStockToRequestDate_(reqDate, colorCode){
  const base = stripStockTag_(reqDate);
  const code = normColorCode(colorCode);
  let qtyLabel = "미등록";
  if(code && stockMap.has(code)) qtyLabel = String(stockMap.get(code));
  const tag = `[재고:${qtyLabel}]`;
  return base ? `${base}  ${tag}` : tag;
}
function colorNameFromStock_(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return "";
  const info = stockInfoMap.get(code);
  return (info?.colorName || "").trim();
}
function nameFromStock_(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return "";
  const info = stockInfoMap.get(code);
  if(!info) return "";
  const a = (info.name || "").trim();
  const b = (info.colorName || "").trim();
  if(a && b) return `${a} ${b}`;
  return a || b || "";
}

/* =========================================================
   Stock cache (10 min)
========================================================= */
const STOCK_CACHE_KEY = "SHIPMENT_STOCK_CSV_CACHE_V1";
const STOCK_CACHE_TTL_MS = 10 * 60 * 1000;

function loadStockCache_(){
  try{
    const raw = localStorage.getItem(STOCK_CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.csv || !obj.ts) return null;
    if(Date.now() - obj.ts > STOCK_CACHE_TTL_MS) return null;
    return obj.csv;
  }catch{ return null; }
}
function saveStockCache_(csv){
  try{
    localStorage.setItem(STOCK_CACHE_KEY, JSON.stringify({ ts: Date.now(), csv }));
  }catch{}
}

/* =========================================================
   Order/Exist Load (Lazy)
========================================================= */
let orderLoaded = false;
let existLoaded = false;
let orderExistLoadingPromise = null;

let orderRows = [];
let orderIndexMap = new Map();
let headerIndexMap = new Map();

let existRows = [];
let existHeaderMap = new Map();

function getMatchIndexFromHeader_(){
  const idx = headerIndexMap.get("쇼핑몰 주문번호(필수)");
  if(idx == null){
    const idx2 = headerIndexMap.get("쇼핑몰 주문번호");
    if(idx2 != null) return idx2;
  }
  return 2;
}

async function ensureOrderAndExistLoaded_(){
  if(orderLoaded && existLoaded) return;
  if(orderExistLoadingPromise) return orderExistLoadingPromise;

  orderExistLoadingPromise = (async ()=>{
    setDashStatus_("발주/출고 불러오는 중…", true);
    $("btnSearch").disabled = true;
    try{
      const [orderCsv, existCsv] = await Promise.all([
        fetchCsvSmart(ORDER_CSV_BASE),
        fetchCsvSmart(EXIST_CSV_BASE),
      ]);

      await new Promise((resolve)=>{
        parseCsvWithPapa(orderCsv, (results)=>{
          const rows = results.data || [];
          const header = (rows[0] || []).map(h => normalizeKey(h));

          headerIndexMap = new Map();
          header.forEach((h, idx)=>{ if(h) headerIndexMap.set(h, idx); });

          orderRows = rows.slice(1).filter(r => r && r.length > 1);
          const matchIdx = getMatchIndexFromHeader_();

          orderIndexMap = new Map();
          for(const r of orderRows){
            const k = normalizeOrderNo(r[matchIdx]);
            if(!k) continue;
            if(!orderIndexMap.has(k)) orderIndexMap.set(k, []);
            orderIndexMap.get(k).push(r);
          }

          orderLoaded = true;
          resolve();
        });
      });

      await new Promise((resolve)=>{
        parseCsvWithPapa(existCsv, (results)=>{
          const rows = results.data || [];
          const header = (rows[0] || []).map(h => normalizeKey(h));

          existHeaderMap = new Map();
          header.forEach((h, idx)=>{ if(h) existHeaderMap.set(h, idx); });

          existRows = rows.slice(1).filter(r => r && r.length > 1);
          existLoaded = true;
          resolve();
        });
      });

      setDashStatus_("로딩 완료");
      setDashCounts_(`재고 ${stockMap.size.toLocaleString()} · 발주 ${orderRows.length.toLocaleString()} · 주문번호 ${orderIndexMap.size.toLocaleString()} · 출고 ${existRows.length.toLocaleString()}`);
    }catch(e){
      console.error(e);
      setDashStatus_("로드 실패: 시트 공개(보기 가능) 확인");
      throw e;
    }finally{
      $("btnSearch").disabled = false;
      orderExistLoadingPromise = null;
    }
  })();

  return orderExistLoadingPromise;
}

/* =========================================================
   Build Out rows
========================================================= */
function buildOutFromSheetRow(row){
  const o = {};

  for(const c of EXTRA_COLS){
    o[c.key] = safeGet(row, c.idx);
  }

  for(const h of OUTPUT_HEADERS){
    if(h === "배송수단"){ o[h] = "택배"; continue; }
    if(h === "운송장 번호"){ o[h] = ""; continue; }

    if(h === "상품명"){
      o[h] = safeGet(row, 11) || "";
      continue;
    }

    if(h === "재고"){
      o[h] = "";
      continue;
    }

    const idx = headerIndexMap.get(h);
    o[h] = safeGet(row, idx);
  }

  o["재고"] = stockQtyLabel_(o["상품컬러코드"]);
  o["요청일"] = attachStockToRequestDate_(o["요청일"], o["상품컬러코드"]);

  return o;
}

/* =========================================================
   State
========================================================= */
let lastOutRows = [];
let lastStockTypes = [];
let originalOutRows = [];
let lastSource = "none";

let selectedRowIndexForPreview = null;

/* =========================================================
   Selection + Copy Target (A안)
   - "체크 우선 복사" ON: 체크 있으면 체크된 행만, 없으면 전체
   - OFF: 항상 전체
========================================================= */
function getCheckedIndexes_(){
  const wrap = $("tableWrap");
  const chks = wrap.querySelectorAll("input.rowChk:checked");
  return Array.from(chks).map(c => Number(c.dataset.idx)).filter(n => !Number.isNaN(n));
}

function getCopyTargetIndexes_(){
  if(!lastOutRows || lastOutRows.length === 0) return [];
  const preferCheck = $("toggleSelectMode")?.checked;

  if(preferCheck){
    const checked = getCheckedIndexes_();
    return checked.length ? checked : lastOutRows.map((_, i)=>i);
  }
  return lastOutRows.map((_, i)=>i);
}

function computeTypesByIndexes_(idxs){
  const counts = { ok:0, low:0, out:0, na:0 };
  const types = idxs.map(i => {
    const t = stockStatusByColorCode(lastOutRows[i]?.["상품컬러코드"]).type;
    counts[t] = (counts[t] || 0) + 1;
    return t;
  });
  return { types, counts };
}

function gateBySelection_(){
  const idxs = getCopyTargetIndexes_();
  const checkedCount = getCheckedIndexes_().length;
  const total = lastOutRows.length;

  // target label
  const targetLabel =
    (idxs.length === 0) ? "-" :
    (checkedCount > 0 && $("toggleSelectMode")?.checked) ? `선택 ${checkedCount}/${total}` :
    `전체 ${total}`;

  setDashTarget_(targetLabel);

  const { counts } = computeTypesByIndexes_(idxs);
  const blocked = (counts.low + counts.out + counts.na) > 0;

  // choose dominant warning type priority out > low > na > ok
  let gateType = "ok";
  let gateText = "복사 가능";
  if(blocked){
    if(counts.out > 0){ gateType = "out"; gateText = "차단: OUT 포함"; }
    else if(counts.low > 0){ gateType = "low"; gateText = `차단: LOW(<${LOW_STOCK_THRESHOLD}) 포함`; }
    else { gateType = "na"; gateText = "차단: N/A 포함"; }
  }

  // main copy button & action bar copy button
  $("btnCopy").disabled = blocked || idxs.length === 0;
  $("btnCopy").classList.toggle("danger", blocked);

  // dash gate chip
  setDashGate_(gateType, gateText);

  // action bar
  const ab = $("actionBar");
  const abTitle = $("abTitle");
  const abWarn = $("abWarn");
  const abCopy = $("abCopy");

  const showAction = ($("toggleSelectMode")?.checked && checkedCount > 0);
  ab.classList.toggle("show", showAction);

  if(showAction){
    abTitle.textContent = `선택 ${checkedCount}건`;
    $("abSub").textContent = "체크된 항목만 복사";
    abWarn.className = `warn ${gateType}`;
    abWarn.textContent =
      blocked ? gateText.replace("차단: ", "⚠ ") : "OK · 복사 가능";
    abCopy.disabled = blocked || checkedCount === 0;
    abCopy.className = blocked ? "btn danger" : "btn primary";
  }

  // result subtitle
  $("resultSub").textContent = (total ? `${total.toLocaleString()}건` : "-");

  return { blocked, gateType, gateText, counts, idxs, checkedCount, total };
}

/* =========================================================
   Copy build
========================================================= */
function buildTSV(outRows){
  const INCLUDE_HEADER_ROW = false;
  const lines = [];
  if(INCLUDE_HEADER_ROW){
    lines.push(TABLE_COLS_COPY.map(c => c.label).join("\t"));
  }
  outRows.forEach(o=>{
    const vals = TABLE_COLS_COPY.map(c =>
      String(o[c.key] ?? "").replace(/\t/g," ").replace(/\r?\n/g," ")
    );
    lines.push(vals.join("\t"));
  });
  return lines.join("\n");
}
function buildHTMLTable(outRows){
  const tdStyle = "border:1px solid #eee;padding:6px 8px;text-align:center;vertical-align:middle;";
  const tbody = outRows.map(o => {
    const tds = TABLE_COLS_COPY.map(c =>
      `<td style="${tdStyle}">${escapeHtml(String(o[c.key] ?? ""))}</td>`
    ).join("");
    return `<tr>${tds}</tr>`;
  }).join("");

  return `
    <table style="border-collapse:collapse;">
      <tbody>${tbody}</tbody>
    </table>
  `.trim();
}

async function copyRows_(rowsToCopy){
  const tsv = buildTSV(rowsToCopy);
  const html = buildHTMLTable(rowsToCopy);

  try{
    await navigator.clipboard.write([
      new ClipboardItem({
        "text/plain": new Blob([tsv], { type: "text/plain" }),
        "text/html": new Blob([html], { type: "text/html" }),
      })
    ]);
    showToast(`통째로 복사됨 (${rowsToCopy.length}건)`);
  }catch{
    try{
      await navigator.clipboard.writeText(tsv);
      showToast("복사됨 (서식 제외)");
    }catch{
      showToast("복사 실패");
    }
  }
}

/* =========================================================
   Preview
========================================================= */
function renderPreviewForRow_(idx){
  const body = $("previewBody");
  const sub = $("previewSub");
  const btnAll = $("btnPreviewCopyAll");

  selectedRowIndexForPreview = (idx == null ? null : idx);

  if(idx == null || !lastOutRows[idx]){
    sub.textContent = "선택한 행 없음";
    btnAll.disabled = true;
    body.innerHTML = `
      <div class="preview-empty">
        왼쪽 표에서 <b>행</b>을 클릭하면 상세가 여기에 정리됩니다.<br/>
        셀은 클릭하면 해당 값이 바로 복사됩니다.
      </div>
    `;
    return;
  }

  const row = lastOutRows[idx];
  const st = stockStatusByColorCode(row["상품컬러코드"]);
  const badgeClass = st.type;

  sub.textContent = `#${idx+1} · ${row["__C"] ? "주문번호 있음" : "주문번호 없음"}`;
  btnAll.disabled = false;

  // 핵심 요약
  const summaryName = (row["상품명"] || "").trim();
  const summaryColor = (row["옵션(수집)"] || "").trim();
  const summaryQty = (row["수량"] || "").trim();
  const summaryCode = (row["상품컬러코드"] || "").trim();

  // build kv blocks
  const blocks = [];

  blocks.push(`
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <span class="badge ${badgeClass}">${escapeHtml(st.label)}</span>
      <span class="badge ok">재고표기: ${escapeHtml(stockQtyLabel_(summaryCode))}</span>
    </div>
  `);

  blocks.push(kv_("상품", `${summaryName}${summaryColor ? " / " + summaryColor : ""}`));
  blocks.push(kv_("수량", summaryQty || "-"));
  blocks.push(kv_("상품컬러코드", summaryCode || "-"));
  blocks.push(kv_("사방넷주문번호", String(row["__B"] || "-")));
  blocks.push(kv_("쇼핑몰 주문번호", String(row["__C"] || "-")));
  blocks.push(kv_("쇼핑몰", String(row["__D"] || "-")));

  // expandable: show some additional important fields
  const extraKeys = ["바코드","상품코드","요청일","비고","수령인","주소","배송메세지","받는분연락처","받는분 기타연락처"];
  for(const k of extraKeys){
    if(k in row && String(row[k] ?? "").trim()){
      blocks.push(kv_(k, String(row[k])));
    }
  }

  body.innerHTML = `
    ${blocks.join("")}
    <div class="preview-actions">
      <button class="btn" type="button" onclick="openRowModal(${idx})">전체 보기</button>
      <button class="btn" type="button" onclick="copyRowAll(${idx})">행 전체 복사</button>
    </div>
  `;
}

function kv_(k, v){
  return `
    <div class="kv">
      <div class="k">${escapeHtml(k)}</div>
      <div class="v">${escapeHtml(String(v ?? ""))}</div>
    </div>
  `;
}

/* =========================================================
   Modal
========================================================= */
let modalCopyPayload = "";
function openModal_(text){
  modalCopyPayload = String(text ?? "");
  $("modalBody").textContent = modalCopyPayload;
  $("modalBackdrop").classList.add("show");
}
function closeModal_(){
  $("modalBackdrop").classList.remove("show");
  modalCopyPayload = "";
  $("modalBody").textContent = "";
}
async function copyModal_(){
  const t = modalCopyPayload || "";
  if(!t.trim()){
    showToast("복사할 내용 없음");
    return;
  }
  try{
    await navigator.clipboard.writeText(t);
    showToast("복사됨");
  }catch{
    showToast("복사 실패");
  }
}
window.openRowModal = function(idx){
  if(idx == null || !lastOutRows[idx]) return;
  const row = lastOutRows[idx];
  // pretty text
  const lines = [];
  for(const c of TABLE_COLS_COPY){
    const label = c.label;
    const val = String(row[c.key] ?? "");
    lines.push(`${label}: ${val}`);
  }
  openModal_(lines.join("\n"));
};
window.copyRowAll = async function(idx){
  if(idx == null || !lastOutRows[idx]) return;
  await copyRows_([lastOutRows[idx]]);
};

/* =========================================================
   Render Table
========================================================= */
function renderTable(outRows, stockTypes){
  const wrap = $("tableWrap");

  lastOutRows = outRows || [];
  lastStockTypes = stockTypes || [];
  selectedRowIndexForPreview = null;

  if(!outRows || outRows.length === 0){
    wrap.innerHTML = `<div class="nodata">검색 결과가 없습니다.</div>`;
    $("btnSelectAll").style.display = "none";
    $("btnSelectNone").style.display = "none";
    renderPreviewForRow_(null);
    gateBySelection_();
    return;
  }

  const showCheckbox = outRows.length > 1;
  $("btnSelectAll").style.display = showCheckbox ? "" : "none";
  $("btnSelectNone").style.display = showCheckbox ? "" : "none";

  const cols = getCurrentViewCols_();

  let html = `<table>
    <thead>
      <tr>
        <th class="stickyA" style="min-width:48px; max-width:48px;">#</th>
        <th class="stickyB" style="min-width:64px; max-width:32px; text-align:center;">선택</th>

        ${cols.map(c=>{
          const w = COL_WIDTH[c.label] || COL_WIDTH["_default"];
          return `<th style="min-width:${w}px; max-width:${w}px;">${escapeHtml(c.label)}</th>`;
        }).join("")}
      </tr>
    </thead>
    <tbody>`;

  outRows.forEach((o, i)=>{
    const t = stockTypes[i] || "na";
    const trClass = (t==="low" ? "low" : t==="out" ? "out" : t==="na" ? "na" : "");
    html += `<tr class="${trClass}" data-row="${i}">
      <td class="stickyA cell" data-copy="${i+1}" style="min-width:48px; max-width:48px;">${i+1}</td>
      <td class="stickyB chkcell" style="min-width:32px; max-width:64px;">
        ${showCheckbox ? `<input type="checkbox" class="rowChk" data-idx="${i}">` : ``}
      </td>
      ${cols.map(c=>{
        const w = COL_WIDTH[c.label] || COL_WIDTH["_default"];
        const raw = String(o[c.key] ?? "");
        return `<td class="cell"
          style="min-width:${w}px; max-width:${w}px;"
          data-copy="${escapeHtml(raw)}"
          data-full="${escapeHtml(raw)}"
          data-row="${i}"
          data-key="${escapeHtml(c.label)}"
        >${escapeHtml(raw)}</td>`;
      }).join("")}
    </tr>`;
  });

  html += `</tbody></table>`;
  wrap.innerHTML = html;

  // events: checkbox
  wrap.querySelectorAll("input.rowChk").forEach(chk=>{
    chk.addEventListener("change", ()=>{
      const tr = chk.closest("tr");
      if(tr) tr.classList.toggle("is-selected", chk.checked);
      // selection affects copy gate
      gateBySelection_();
    });
  });

  // row click → preview (but ignore when clicking checkbox itself)
  wrap.querySelectorAll("tbody tr").forEach(tr=>{
    tr.addEventListener("click", (e)=>{
      const t = e.target;
      if(t && (t.classList.contains("rowChk"))) return;

      const idx = Number(tr.getAttribute("data-row"));
      if(Number.isNaN(idx)) return;
      renderPreviewForRow_(idx);

      // subtle selection highlight for preview row (optional)
      wrap.querySelectorAll("tbody tr").forEach(x=>x.classList.remove("is-preview"));
      tr.classList.add("is-preview");
    });
  });

  // cell click → copy value (not whole row)
  wrap.querySelectorAll("td.cell").forEach(td=>{
    td.addEventListener("click", async (e)=>{
      // prevent row click? we still want row preview; allow both but copy is immediate
      const text = (td.getAttribute("data-full") || td.textContent || "").trim();
      if(!text){
        showToast("빈 값");
        return;
      }
      try{
        await navigator.clipboard.writeText(text);
        showToast("값 복사됨");
      }catch{
        showToast("복사 실패");
      }
    });

    // double click → open modal full value
    td.addEventListener("dblclick", (e)=>{
      const key = td.getAttribute("data-key") || "값";
      const text = (td.getAttribute("data-full") || td.textContent || "").trim();
      openModal_(`${key}\n\n${text}`);
    });
  });

  // initial gate
  renderPreviewForRow_(null);
  gateBySelection_();
}

/* =========================================================
   Load Stock first
========================================================= */
async function loadStockOnly(){
  setDashStatus_("재고 로딩 중…", true);
  setDashCounts_("-");
  setDashTarget_("-");
  setDashGate_("na", "대기");
  $("btnCopy").disabled = true;

  try{
    const cached = loadStockCache_();
    if(cached){
      await new Promise((resolve)=>{
        parseCsvWithPapa(cached, (results)=>{
          buildStockMapsFromParsed_(results);
          resolve();
        });
      });
      stockLoaded = true;
      setDashStatus_("재고 로딩 완료 (캐시)");
      setDashCounts_(`재고 ${stockMap.size.toLocaleString()} · 발주/출고는 조회 시 로드`);
    }

    const stockCsv = await fetchCsvSmart(STOCK_CSV_BASE);
    if(!looksLikeBadCsv(stockCsv)){
      saveStockCache_(stockCsv);
      await new Promise((resolve)=>{
        parseCsvWithPapa(stockCsv, (results)=>{
          buildStockMapsFromParsed_(results);
          resolve();
        });
      });
      stockLoaded = true;
      setDashStatus_("재고 로딩 완료");
      setDashCounts_(`재고 ${stockMap.size.toLocaleString()} · 발주/출고는 조회 시 로드`);
    }else{
      if(!stockLoaded) setDashStatus_("재고 로드 실패: 시트 공개(보기 가능) 확인");
    }
  }catch(e){
    console.error(e);
    if(!stockLoaded) setDashStatus_("재고 로드 실패: 시트 공개(보기 가능) 확인");
  }
}

/* =========================================================
   Search
========================================================= */
async function search(){
  const orderNo = normalizeOrderNo($("orderInput").value);

  // reset view state
  lastOutRows = [];
  lastStockTypes = [];
  originalOutRows = [];
  lastSource = "none";
  selectedRowIndexForPreview = null;

  $("btnCopy").disabled = true;
  $("btnCopy").classList.remove("danger");
  $("resultSub").textContent = "-";
  $("tableWrap").innerHTML = `<div class="nodata">검색 중…</div>`;
  renderPreviewForRow_(null);

  if(!orderNo){
    $("tableWrap").innerHTML = `<div class="nodata">주문번호를 입력해주세요.</div>`;
    setDashStatus_("주문번호 입력 필요");
    gateBySelection_();
    return;
  }
  if(!stockLoaded){
    $("tableWrap").innerHTML = `<div class="nodata">재고가 아직 로딩 중입니다…</div>`;
    setDashStatus_("재고 로딩 중…", true);
    return;
  }

  setDashStatus_("조회 중…", true);

  if(!orderLoaded || !existLoaded){
    try{
      await ensureOrderAndExistLoaded_();
    }catch{
      $("tableWrap").innerHTML = `<div class="nodata">발주/출고 시트를 불러오지 못했습니다. (시트 공개 확인)</div>`;
      setDashStatus_("발주/출고 로드 실패");
      gateBySelection_();
      return;
    }
  }

  const rows = orderIndexMap.get(orderNo) || [];
  if(rows.length === 0){
    setDashStatus_("검색 결과 없음");
    $("tableWrap").innerHTML = `<div class="nodata">발주서에서 주문번호를 찾지 못했습니다.</div>`;
    gateBySelection_();
    return;
  }

  const outRows = rows.map(r => buildOutFromSheetRow(r));
  const stockTypes = outRows.map(o => stockStatusByColorCode(o["상품컬러코드"]).type);

  lastSource = "sheet";
  originalOutRows = JSON.parse(JSON.stringify(outRows));

  renderTable(outRows, stockTypes);
  setDashStatus_(`검색 완료 · ${outRows.length.toLocaleString()}건`);
}

/* =========================================================
   Bulk buttons (select all/none)
========================================================= */
$("btnSelectAll").addEventListener("click", ()=>{
  const wrap = $("tableWrap");
  wrap.querySelectorAll("input.rowChk").forEach(c => c.checked = true);
  wrap.querySelectorAll("tbody tr").forEach(tr => tr.classList.add("is-selected"));
  gateBySelection_();
});
$("btnSelectNone").addEventListener("click", ()=>{
  const wrap = $("tableWrap");
  wrap.querySelectorAll("input.rowChk").forEach(c => c.checked = false);
  wrap.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("is-selected"));
  gateBySelection_();
});

/* =========================================================
   Copy buttons
========================================================= */
$("btnCopy").addEventListener("click", async ()=>{
  if(!lastOutRows || lastOutRows.length === 0){
    showToast("복사할 결과 없음");
    return;
  }
  const gate = gateBySelection_();
  if(gate.blocked){
    showToast("재고 경고로 복사 차단됨");
    return;
  }
  const rowsToCopy = gate.idxs.map(i => lastOutRows[i]);
  await copyRows_(rowsToCopy);
});

$("abCopy").addEventListener("click", async ()=>{
  const checked = getCheckedIndexes_();
  if(!checked.length) return;
  const idxs = checked; // action bar is only for selection mode
  const { counts } = computeTypesByIndexes_(idxs);
  const blocked = (counts.low + counts.out + counts.na) > 0;
  if(blocked){
    showToast("재고 경고로 복사 차단됨");
    return;
  }
  await copyRows_(idxs.map(i => lastOutRows[i]));
});

$("abClear").addEventListener("click", ()=>{
  const wrap = $("tableWrap");
  wrap.querySelectorAll("input.rowChk").forEach(c => c.checked = false);
  wrap.querySelectorAll("tbody tr").forEach(tr => tr.classList.remove("is-selected"));
  gateBySelection_();
});

$("btnPreviewCopyAll").addEventListener("click", async ()=>{
  if(selectedRowIndexForPreview == null) return;
  await copyRows_([lastOutRows[selectedRowIndexForPreview]]);
});

/* =========================================================
   Details toggle re-render
========================================================= */
$("toggleDetails").addEventListener("change", ()=>{
  if(!lastOutRows || lastOutRows.length === 0) return;
  // preserve checks
  const checked = new Set(getCheckedIndexes_());
  renderTable(lastOutRows, lastStockTypes);
  // re-check
  const wrap = $("tableWrap");
  wrap.querySelectorAll("input.rowChk").forEach(chk=>{
    const idx = Number(chk.dataset.idx);
    if(checked.has(idx)){
      chk.checked = true;
      chk.closest("tr")?.classList.add("is-selected");
    }
  });
  gateBySelection_();
});

$("toggleSelectMode").addEventListener("change", ()=>{
  gateBySelection_();
});

/* =========================================================
   Clear
========================================================= */
$("btnClear").addEventListener("click", ()=>{
  $("orderInput").value = "";
  $("tableWrap").innerHTML = `<div class="nodata">검색 결과가 없습니다.</div>`;
  renderPreviewForRow_(null);

  lastOutRows = [];
  lastStockTypes = [];
  originalOutRows = [];
  lastSource = "none";
  selectedRowIndexForPreview = null;

  $("btnCopy").disabled = true;
  $("btnCopy").classList.remove("danger");

  $("actionBar").classList.remove("show");
  setDashStatus_("초기화됨");
  setDashTarget_("-");
  setDashGate_("na", "대기");
  $("resultSub").textContent = "-";
});

/* =========================================================
   Search triggers
========================================================= */
$("orderInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") search();
});
$("btnSearch").addEventListener("click", search);

/* =========================================================
   Modal events
========================================================= */
$("btnModalClose").addEventListener("click", closeModal_);
$("btnModalCopy").addEventListener("click", copyModal_);
$("modalBackdrop").addEventListener("click", (e)=>{
  if(e.target === $("modalBackdrop")) closeModal_();
});
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeModal_();
});

/* =========================================================
   Init
========================================================= */
loadStockOnly();
</script>
</body>
</html>

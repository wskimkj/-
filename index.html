<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>발주 조회 + 재고 경고</title>

  <link rel="stylesheet" as="style" crossorigin
    href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg1:#f7f4ff; --bg2:#eef6ff;
      --card:rgba(255,255,255,.9);
      --stroke:rgba(170,150,230,.22);
      --text:#2f2a3a;
      --pink:#ff8fbc;
      --shadow:0 18px 50px rgba(30,18,60,.10);
      --shadow2:0 10px 26px rgba(30,18,60,.08);

      --low-bg: rgba(255, 70, 70, .10);
      --low-border: rgba(255, 70, 70, .35);
      --low-text: rgba(160, 20, 20, .95);

      --out-bg: rgba(255, 35, 35, .16);
      --out-border: rgba(255, 35, 35, .55);
      --out-text: rgba(135, 0, 0, .98);

      --na-bg: rgba(120,120,140,.10);
      --na-border: rgba(120,120,140,.35);
      --na-text: rgba(80,80,95,.95);

      --ok-bg: rgba(184,167,255,.14);
      --ok-border: rgba(170,150,230,.35);
      --ok-text: rgba(47,42,58,.92);
    }
    *{box-sizing:border-box;font-family:"Pretendard",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{
      margin:0; min-height:100vh; color:var(--text);
      background:
        radial-gradient(900px 520px at 20% 18%, rgba(255,143,188,.25), transparent 60%),
        radial-gradient(900px 520px at 82% 24%, rgba(184,167,255,.20), transparent 58%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .container{max-width:1200px;margin:0 auto;padding:28px 16px 46px;}
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:20px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-inner{padding:18px;}
    .title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:18px; font-weight:800;
    }
    .meta{
      margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;
      color:rgba(110,106,130,.85); font-size:12px;
      align-items:center;
    }
    .pill{
      font-size:11px; padding:5px 10px; border-radius:999px;
      background: linear-gradient(90deg, rgba(255,143,188,.20), rgba(184,167,255,.16));
      border:1px solid rgba(170,150,230,.25);
      box-shadow: 0 1px 0 rgba(255,255,255,.55) inset;
      text-decoration:none; color:rgba(47,42,58,.82);
      display:inline-flex; align-items:center; gap:6px;
    }
    .pill:hover{
      border-color: rgba(255,143,188,.55);
      box-shadow: 0 0 0 3px rgba(255,143,188,.14), 0 1px 0 rgba(255,255,255,.55) inset;
    }

    .row{display:flex; gap:10px; align-items:center; margin-top:14px; flex-wrap:wrap;}
    .input{
      flex:1; min-width:240px;
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:14px;
      background:rgba(243,241,250,.85);
      border:1px solid rgba(170,150,230,.20);
      box-shadow: var(--shadow2);
    }
    .input input{
      width:100%; border:0; outline:0; background:transparent;
      font-size:13px;
    }
    .btn{
      border:0; cursor:pointer;
      padding:10px 14px; border-radius:14px;
      background:rgba(255,255,255,.82);
      border:1px solid rgba(170,150,230,.25);
      box-shadow: var(--shadow2);
      font-weight:900;
    }
    .btn:hover{border-color: rgba(255,143,188,.55); box-shadow: 0 0 0 3px rgba(255,143,188,.12), var(--shadow2);}
    .btn:disabled{
      cursor:not-allowed;
      opacity:.55;
      filter:saturate(.8);
      box-shadow:none;
    }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(170,150,230,.25);
      background: rgba(255,255,255,.70);
      font-weight:900;
      font-size:11px;
      white-space:nowrap;
    }
    .badge.ok{ background: var(--ok-bg); border-color: var(--ok-border); color: var(--ok-text); }
    .badge.low{ background: var(--low-bg); border-color: var(--low-border); color: var(--low-text); }
    .badge.out{ background: var(--out-bg); border-color: var(--out-border); color: var(--out-text); }
    .badge.na{ background: var(--na-bg); border-color: var(--na-border); color: var(--na-text); }

    .table-wrap{
      margin-top:14px;
      border-radius:16px; border:1px solid rgba(170,150,230,.18);
      overflow:auto; background: rgba(255,255,255,.68);
      box-shadow: 0 1px 0 rgba(255,255,255,.70) inset;
      max-height: 72vh;
    }
    table{width:100%; border-collapse:separate; border-spacing:0; font-size:12px;}
    thead th{
      position:sticky; top:0; z-index:2;
      text-align:left; padding:10px 12px;
      background: rgba(255,255,255,.86);
      border-bottom: 1px solid rgba(170,150,230,.18);
      font-weight:900;
      white-space:nowrap;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(170,150,230,.12);
      vertical-align:top;
    }
    tbody tr:nth-child(even){background: rgba(243,241,250,.55);}
    tbody tr:hover{background: linear-gradient(90deg, rgba(255,143,188,.18), rgba(184,167,255,.14));}
    .no-data{padding:20px 14px; text-align:center; color: rgba(110,106,130,.75); font-size:12px;}

    tr.low  { background: var(--low-bg) !important; }
    tr.out  { background: var(--out-bg) !important; }
    tr.na   { background: rgba(120,120,140,.07) !important; }

    .copy{cursor:pointer;}
    #toast{
      position:fixed; right:18px; bottom:18px; z-index:9999;
      padding:10px 12px; border-radius:14px;
      background: rgba(255,255,255,.90);
      border:1px solid rgba(255,143,188,.35);
      box-shadow: var(--shadow);
      opacity:0; transform: translateY(10px);
      transition:.18s ease;
      pointer-events:none;
    }
    #toast.show{opacity:1; transform:translateY(0);}

    .mini{font-size:11px;color: rgba(110,106,130,.85);}
    .warnline{font-size:11px; font-weight:900;}
    .warnline.low{color: var(--low-text);}
    .warnline.out{color: var(--out-text);}
    .warnline.na{color: var(--na-text);}
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="card-inner">

        <div class="title">
          <div>발주 조회 + 재고 경고</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <a class="pill" id="orderLink" href="#" target="_blank" rel="noopener noreferrer">발주서 열기</a>
            <a class="pill" id="stockLink" href="#" target="_blank" rel="noopener noreferrer">재고시트 열기</a>
          </div>
        </div>

        <div class="meta">
          <span id="status">데이터 로딩 중…</span>
          <span class="mini" id="stat2"></span>
          <span id="stockSummary"></span>
          <span id="copyGateMsg"></span>
        </div>

        <div class="row">
          <div class="input">
            <span style="font-size:12px;opacity:.75;">주문번호</span>
            <input id="orderInput" type="text" placeholder="쇼핑몰 주문번호(발주서 C열) 입력 후 Enter" />
          </div>
          <button class="btn" id="btnSearch">조회</button>
          <button class="btn" id="btnCopy" disabled>복사</button>
          <button class="btn" id="btnClear">초기화</button>
        </div>

        <div class="table-wrap" id="tableWrap">
          <div class="no-data">검색 결과가 없습니다.</div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast">복사됨</div>

<script>
/* ===================== ✅ 기준 설정 ===================== */
const LOW_STOCK_THRESHOLD = 5; // ✅ "5개 미만" 경고/차단 기준

/* ===================== ✅ Sheet Config ===================== */
// 발주서
const ORDER_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/edit?gid=518656308#gid=518656308";
const ORDER_CSV_URL =
  "https://docs.google.com/spreadsheets/d/1_Bxfag-90U6u-6JbhxNqeoD9vRns-CpPeXPIJYO1Z5o/export?format=csv&gid=518656308";

// 재고 시트
const STOCK_SHEET_URL_VIEW =
  "https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/edit?gid=366983013#gid=366983013";
const STOCK_CSV_URL =
  "https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/export?format=csv&gid=366983013";

// 링크 세팅
document.getElementById("orderLink").href = ORDER_SHEET_URL_VIEW;
document.getElementById("stockLink").href = STOCK_SHEET_URL_VIEW;

/* ===================== ✅ Output Columns (요청 순서) ===================== */
const OUTPUT_HEADERS = [
  "요청일","목적","전산 처리 방법","요청자",
  "수령인","배송수단","운송장 번호","받는분연락처","받는분 기타연락처","주소","배송메세지",
  "상품컬러명(플레이엠디)","수량","결제금액","큐텐(한글상품명)","바코드","큐텐바코드",
  "상품코드","쇼핑몰(참고용)","상품컬러코드","상품명(수집)","옵션(수집)","주문자명",
  "비고"
];

/**
 * ✅ 매칭 키: 발주서 C열 "쇼핑몰 주문번호(필수)"
 * CSV row는 0-based: A=0, B=1, C=2
 */
const MATCH_COL_INDEX = 2;

/* ===================== Utilities ===================== */
const $ = (id)=>document.getElementById(id);

function showToast(msg="복사됨"){
  const el = $("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 850);
}

async function fetchText(url, timeoutMs = 9000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, { signal: controller.signal });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  } finally {
    clearTimeout(t);
  }
}

function normalizeKey(v){
  return String(v ?? "").trim();
}

function normColorCode(v){
  return normalizeKey(v).replace(/\s+/g,"").replace(/-/g,"").toUpperCase();
}

function toNumber(v){
  const n = String(v ?? "").replace(/[^0-9.-]/g,"");
  return Number(n) || 0;
}

function escapeHtml(str){
  return str
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===================== Data Stores ===================== */
let orderHeader = [];
let orderRows = [];
let headerIndexMap = new Map();
let orderIndexMap = new Map(); // 주문번호 -> [row,row,...]
let stockMap = new Map();      // 컬러코드 -> 재고수량(number)
let lastResultRows = [];       // 복사용 캐시

/* ===================== Load Both CSV ===================== */
async function loadAll(){
  $("status").textContent = "데이터 로딩 중… (발주서/재고)";
  $("stat2").textContent = "";
  $("stockSummary").textContent = "";
  $("copyGateMsg").textContent = "";
  $("btnCopy").disabled = true;

  try{
    const [orderCsv, stockCsv] = await Promise.all([
      fetchText(ORDER_CSV_URL),
      fetchText(STOCK_CSV_URL)
    ]);

    // 발주서
    await new Promise((resolve)=>{
      Papa.parse(orderCsv, {
        complete: (results)=>{
          const rows = results.data || [];
          orderHeader = (rows[0] || []).map(h => String(h ?? "").trim());
          orderRows = rows.slice(1).filter(r => r && r.length > 1);

          headerIndexMap = new Map();
          orderHeader.forEach((h, idx)=>{ if(h) headerIndexMap.set(h, idx); });

          // ✅ 속도 개선: 주문번호 -> 행 배열 Map
          orderIndexMap = new Map();
          for(const r of orderRows){
            const k = normalizeKey(r[MATCH_COL_INDEX]);
            if(!k) continue;
            if(!orderIndexMap.has(k)) orderIndexMap.set(k, []);
            orderIndexMap.get(k).push(r);
          }
          resolve();
        }
      });
    });

    // 재고 (A=컬러코드(0), K=재고(10))
    await new Promise((resolve)=>{
      Papa.parse(stockCsv, {
        complete: (results)=>{
          const rows = (results.data || []).slice(1).filter(r => r && r.length > 0);
          stockMap = new Map();
          for(const r of rows){
            const code = normColorCode(r[0]);
            const qty = toNumber(r[10]);
            if(code) stockMap.set(code, qty);
          }
          resolve();
        }
      });
    });

    $("status").textContent = "로딩 완료";
    $("stat2").textContent =
      `발주 ${orderRows.length.toLocaleString()}건 · 주문번호 키 ${orderIndexMap.size.toLocaleString()}개 · 재고코드 ${stockMap.size.toLocaleString()}개`;
  }catch(e){
    console.error(e);
    $("status").textContent = "로드 실패: 시트가 '보기 가능' 공개인지 확인하세요.";
  }
}

/* ===================== Stock Status ===================== */
function stockStatusByColorCode(colorCodeRaw){
  const code = normColorCode(colorCodeRaw);
  if(!code) return { type:"na", label:"재고 미등록", qty:null };

  if(!stockMap.has(code)){
    return { type:"na", label:"재고 미등록", qty:null };
  }

  const qty = stockMap.get(code);

  if(qty <= 0) return { type:"out", label:`재고 0`, qty };
  if(qty < LOW_STOCK_THRESHOLD) return { type:"low", label:`재고 ${qty} (${LOW_STOCK_THRESHOLD} 미만)`, qty };
  return { type:"ok", label:`재고 ${qty}`, qty };
}

/* ===================== Render ===================== */
function safeGet(row, idx){
  if(!row || idx == null || idx < 0) return "";
  return (row[idx] ?? "");
}

/**
 * ✅ 화면 표시용 오버라이드
 * - 배송수단: 항상 "택배"
 * - 운송장 번호: 항상 빈칸
 */
function buildOutRow(row){
  const obj = {};
  for(const h of OUTPUT_HEADERS){
    if(h === "배송수단"){ obj[h] = "택배"; continue; }
    if(h === "운송장 번호"){ obj[h] = ""; continue; }
    const idx = headerIndexMap.get(h);
    obj[h] = safeGet(row, idx);
  }
  return obj;
}

function renderStockSummaryAndGate(rows){
  const el = $("stockSummary");
  const gate = $("copyGateMsg");
  const btnCopy = $("btnCopy");

  el.textContent = "";
  gate.textContent = "";
  gate.className = "";

  // 결과 없으면 복사 막기
  if(!rows || rows.length === 0){
    btnCopy.disabled = true;
    return;
  }

  const ccIdx = headerIndexMap.get("상품컬러코드");
  let ok=0, low=0, out=0, na=0;

  // 행별 재고 상태 집계
  for(const r of rows){
    const st = stockStatusByColorCode(safeGet(r, ccIdx));
    if(st.type === "ok") ok++;
    else if(st.type === "low") low++;
    else if(st.type === "out") out++;
    else na++;
  }

  // 배지 표시
  const badges = [];
  if(out) badges.push(`<span class="badge out">OUT ${out}건</span>`);
  if(low) badges.push(`<span class="badge low">LOW ${low}건</span>`);
  if(na)  badges.push(`<span class="badge na">N/A ${na}건</span>`);
  if(!out && !low && !na) badges.push(`<span class="badge ok">OK ${ok}건</span>`);

  el.innerHTML = badges.join(" ");

  // ✅ 실수 방지: OUT/LOW/N/A 하나라도 있으면 복사 차단
  const blocked = (out > 0 || low > 0 || na > 0);
  btnCopy.disabled = blocked;

  if(blocked){
    if(out > 0){
      gate.innerHTML = `출고요청 방지: <strong>재고 0(OUT)</strong> 포함`;
      gate.className = "warnline out";
    }else if(low > 0){
      gate.innerHTML = `출고요청 방지: <strong>재고 ${LOW_STOCK_THRESHOLD} 미만(LOW)</strong> 포함`;
      gate.className = "warnline low";
    }else{
      gate.innerHTML = `출고요청 방지: <strong>재고 미등록(N/A)</strong> 포함`;
      gate.className = "warnline na";
    }
  }else{
    gate.innerHTML = `<span class="warnline" style="color:rgba(47,42,58,.85)">복사 가능</span>`;
    gate.className = "warnline";
  }
}

function renderList(rows){
  const wrap = $("tableWrap");
  lastResultRows = rows || [];

  renderStockSummaryAndGate(rows);

  if(!rows || rows.length === 0){
    wrap.innerHTML = `<div class="no-data">해당 주문번호를 찾지 못했습니다.</div>`;
    return;
  }

  const ccIdx = headerIndexMap.get("상품컬러코드");

  let html = `<table>
    <thead>
      <tr>
        <th style="min-width:48px;">#</th>
        ${OUTPUT_HEADERS.map(h=>`<th style="min-width:140px;">${escapeHtml(h)}</th>`).join("")}
      </tr>
    </thead>
    <tbody>`;

  rows.forEach((r, i)=>{
    const out = buildOutRow(r);
    const status = stockStatusByColorCode(safeGet(r, ccIdx));

    const trClass = (status.type === "low") ? "low" :
                    (status.type === "out") ? "out" :
                    (status.type === "na")  ? "na" : "";

    html += `<tr class="${trClass}">
      <td class="copy" data-copy="${i+1}">${i+1}</td>
      ${OUTPUT_HEADERS.map(h=>{
        const v = out[h] ?? "";
        return `<td class="copy" data-copy="${escapeHtml(String(v).trim())}">${escapeHtml(String(v))}</td>`;
      }).join("")}
    </tr>`;
  });

  html += `</tbody></table>`;
  wrap.innerHTML = html;

  // 셀 단위 클릭 복사
  wrap.querySelectorAll(".copy").forEach(td=>{
    td.addEventListener("click", async ()=>{
      const text = (td.getAttribute("data-copy") || td.textContent || "").trim();
      try{
        await navigator.clipboard.writeText(text);
        showToast("복사됨");
      }catch{
        showToast("복사 실패");
      }
    });
  });
}

/* ===================== 통째 복사 (TSV) ===================== */
function buildTSVFromRows(rows){
  const INCLUDE_HEADER_ROW = false;
  const lines = [];

  if(INCLUDE_HEADER_ROW){
    lines.push([...OUTPUT_HEADERS].join("\t"));
  }

  rows.forEach((r)=>{
    const out = buildOutRow(r);
    const rowValues = OUTPUT_HEADERS.map(h => String(out[h] ?? ""));
    const sanitized = rowValues.map(v => v.replace(/\t/g, " ").replace(/\r?\n/g, " "));
    lines.push(sanitized.join("\t"));
  });

  return lines.join("\n");
}

/* ===================== Search ===================== */
function search(){
  const orderNo = normalizeKey($("orderInput").value);
  if(!orderNo){
    $("tableWrap").innerHTML = `<div class="no-data">주문번호를 입력해주세요.</div>`;
    lastResultRows = [];
    $("btnCopy").disabled = true;
    $("stockSummary").textContent = "";
    $("copyGateMsg").textContent = "";
    return;
  }

  const rows = orderIndexMap.get(orderNo) || [];
  $("status").textContent = rows.length
    ? `검색 결과: ${rows.length.toLocaleString()}건`
    : "검색 결과 없음";

  renderList(rows);
}

/* ===================== Events ===================== */
$("btnSearch").addEventListener("click", search);

$("btnCopy").addEventListener("click", async ()=>{
  if(!lastResultRows || lastResultRows.length === 0){
    showToast("복사할 결과 없음");
    return;
  }
  if($("btnCopy").disabled){
    showToast("재고 경고로 복사 차단됨");
    return;
  }
  const tsv = buildTSVFromRows(lastResultRows);
  try{
    await navigator.clipboard.writeText(tsv);
    showToast(`통째로 복사됨 (${lastResultRows.length}건)`);
  }catch(e){
    console.error(e);
    showToast("복사 실패");
  }
});

$("btnClear").addEventListener("click", ()=>{
  $("orderInput").value = "";
  $("status").textContent = "초기화됨";
  $("tableWrap").innerHTML = `<div class="no-data">검색 결과가 없습니다.</div>`;
  $("stockSummary").textContent = "";
  $("copyGateMsg").textContent = "";
  lastResultRows = [];
  $("btnCopy").disabled = true;
});

$("orderInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); search(); }
});

/* ===================== Boot ===================== */
loadAll();
</script>
</body>
</html>
